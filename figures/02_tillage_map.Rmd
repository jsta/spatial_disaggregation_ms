---
title: "Figures"
output:
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/", fig.width = 5, fig.height = 6)
```

```{r read_chunks, cache=FALSE, echo=FALSE}
# setwd("scripts"); source("../scripts/99_utils.R")
knitr::read_chunk("../scripts/99_utils.R")
```

```{r source_utils, message=FALSE, results='hide', echo=FALSE, warning=FALSE}

```

```{r 02_tillage_map, echo=FALSE, warning=FALSE, fig.width = 5.5, fig.height = 3}
# ---- tillage_map ----
library(macroag)

data("tillage_ctic")
# setwd("scripts")
gpkg_path <- "../data/gis.gpkg"
hu4s      <- st_read(gpkg_path, layer = "hu4s")
hu8s      <- st_read(gpkg_path, layer = "hu8s")
states    <- st_read(gpkg_path, layer = "states")
counties  <- st_read(gpkg_path, layer = "counties")
lg        <- lagosne_load()

n_cat      <- 4
colors     <- c("red", "yellow", "blue", "green")
break_cuts <- c(0, 10, 25, 50, 100)

tc <- dplyr::filter(tillage_ctic, huc8_n %in% as.character(hu8s$HUC8)) %>%
    left_join(dplyr::select(lg$hu8, hu8, hu8_zoneid),
            by = c("huc8_n" = "hu8")) %>%
  dplyr::filter(year == 2004 & crop == "allcrops")
hu8s <- dplyr::left_join(hu8s, tc, by = c("ZoneID" = "hu8_zoneid"))
hu8s    <- mutate(hu8s, 
                 pctnotil_cat = cut(hu8s$pctnotil, breaks = break_cuts))
hu8s <- dplyr::filter(hu8s, !is.na(pctnotil))

if(!file.exists("../data/counties_tillage.rds")){
  counties <- st_transform(counties, st_crs(hu8s))
  counties <- st_cast(counties, "MULTIPOLYGON")
  counties <- sf::st_interpolate_aw(hu8s["pctnotil"], counties, extensive = FALSE)
  counties <- mutate(counties,
                     pctnotil_cat = cut(counties$pctnotil, breaks = break_cuts))
  saveRDS(counties, "../data/counties_tillage.rds")
}
counties <- readRDS("../data/counties_tillage.rds")

if(!file.exists("../data/hu4_tillage.rds")){
  hu4_pctnotil <- hu8s %>% 
    mutate(HUC4 = substring(HUC8, 0, 4)) %>%
    mutate(notilarea_j = pctnotil * Shape_Area) %>%
    group_by(HUC4) %>%
    summarize(pctnotil = sum(notilarea_j, na.rm = TRUE) / sum(Shape_Area)) %>%
    st_drop_geometry()
  
  hu4s <- hu4s %>% 
    left_join(hu4_pctnotil) %>% 
    mutate(pctnotil_cat = cut(pctnotil, breaks = break_cuts))
   saveRDS(hu4s, "../data/hu4_tillage.rds")
}
hu4s <- readRDS("../data/hu4_tillage.rds")

g_hu8 <- ggplot() +
  geom_sf(data = hu8s, aes(fill = pctnotil_cat), size = 0.2) +
  scale_fill_manual(name = "tillage %", 
                    values = colors, levels(hu8s$pctnotil_cat)) + 
  geom_sf(data = states, alpha = 0, size = 0.5) +
  coord_sf(datum = NA) +
  theme_opts
g_counties <- ggplot() +
  geom_sf(data = counties, aes(fill = pctnotil_cat), size = 0.2) +
  scale_fill_manual(values = colors, levels(counties$pctnotil_cat)) +
  geom_sf(data = states, alpha = 0, size = 0.5) +
  coord_sf(datum = NA) +
  theme_opts
g_hu4 <- ggplot() +
  geom_sf(data = hu4s, aes(fill = pctnotil_cat), size = 0.2) +
  scale_fill_manual(name = "tillage %", 
                    values = colors, levels(hu4s$pctnotil_cat)) + 
  geom_sf(data = states, alpha = 0, size = 0.5) +
  coord_sf(datum = NA) +
  theme_opts
legend <- get_legend(g_hu8)

plot_grid(g_hu4 + theme(legend.position = "none"),
          g_hu8 + theme(legend.position = "none"), 
          g_counties + theme(legend.position = "none"), 
          legend, 
          nrow = 1)
```
